#!/bin/bash

# AI ê¸°ë°˜ ìë™ PR ìƒì„± ìŠ¤í¬ë¦½íŠ¸
# ì‚¬ìš©ë²•: ./scripts/ai-pr.sh

set -e

# ìƒ‰ìƒ ì •ì˜
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ì„¤ì • ë¡œë“œ
source ~/.ai-dev-tools/config.sh

# í•¨ìˆ˜: API í‚¤ í™•ì¸
check_api_key() {
    if [ -z "$OPENAI_API_KEY" ] && [ -z "$ANTHROPIC_API_KEY" ]; then
        echo -e "${RED}âŒ API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.${NC}"
        exit 1
    fi
}

# í•¨ìˆ˜: GitHub CLI í™•ì¸
check_gh_cli() {
    if ! command -v gh &> /dev/null; then
        echo -e "${RED}âŒ GitHub CLIê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.${NC}"
        echo "ì„¤ì¹˜: brew install gh"
        echo "ë¡œê·¸ì¸: gh auth login"
        exit 1
    fi

    if ! gh auth status &> /dev/null; then
        echo -e "${RED}âŒ GitHub CLIì— ë¡œê·¸ì¸ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.${NC}"
        echo "ë¡œê·¸ì¸: gh auth login"
        exit 1
    fi
}

# í•¨ìˆ˜: ì›ê²© ì €ì¥ì†Œ ê°ì§€ ë° ì„¤ì •
setup_remote_repository() {
    echo -e "${BLUE}ğŸ” ì›ê²© ì €ì¥ì†Œë¥¼ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤...${NC}"
    
    # ëª¨ë“  ì›ê²© ì €ì¥ì†Œ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    local remotes=($(git remote))
    
    if [ ${#remotes[@]} -eq 0 ]; then
        echo -e "${YELLOW}âš ï¸  ì›ê²© ì €ì¥ì†Œê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.${NC}"
        echo -e "${BLUE}ğŸ’¡ GitHub ì €ì¥ì†Œë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?${NC}"
        
        read -p "GitHub ì €ì¥ì†Œë¥¼ ìƒì„±í•˜ê³  ì—°ê²°í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/N): " -r
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            # í˜„ì¬ ë””ë ‰í† ë¦¬ëª…ì„ ì €ì¥ì†Œ ì´ë¦„ìœ¼ë¡œ ì‚¬ìš©
            local repo_name=$(basename "$(pwd)")
            
            echo -e "${BLUE}ğŸ“¦ GitHubì— '$repo_name' ì €ì¥ì†Œë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...${NC}"
            
            # GitHub CLIë¡œ ì €ì¥ì†Œ ìƒì„±
            if gh repo create "$repo_name" --private --source=. --remote=origin --push; then
                echo -e "${GREEN}âœ… GitHub ì €ì¥ì†Œê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ê³  ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!${NC}"
                DEFAULT_REMOTE="origin"
                # ì›ê²© ì €ì¥ì†Œ ëª©ë¡ ì¬ê°±ì‹ 
                remotes=($(git remote))
            else
                echo -e "${RED}âŒ GitHub ì €ì¥ì†Œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.${NC}"
                echo -e "${YELLOW}ğŸ’¡ ìˆ˜ë™ìœ¼ë¡œ ì €ì¥ì†Œë¥¼ ìƒì„±í•˜ê³  ì›ê²© ì €ì¥ì†Œë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”:${NC}"
                echo "git remote add origin <ì €ì¥ì†Œ-URL>"
                exit 1
            fi
        else
            echo -e "${YELLOW}ğŸ’¡ ìˆ˜ë™ìœ¼ë¡œ GitHubì— ì €ì¥ì†Œë¥¼ ìƒì„±í•˜ê³  ì›ê²© ì €ì¥ì†Œë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”:${NC}"
            echo "git remote add origin <ì €ì¥ì†Œ-URL>"
            exit 1
        fi
    else
        # ê¸°ë³¸ ì›ê²© ì €ì¥ì†Œ ê²°ì •
        if [[ " ${remotes[*]} " =~ " origin " ]]; then
            DEFAULT_REMOTE="origin"
        elif [[ " ${remotes[*]} " =~ " upstream " ]]; then
            DEFAULT_REMOTE="upstream"
        else
            DEFAULT_REMOTE="${remotes[0]}"
        fi
    fi
    
    # í¬í¬ëœ ì €ì¥ì†Œì¸ì§€ í™•ì¸ (originê³¼ upstreamì´ ëª¨ë‘ ìˆëŠ” ê²½ìš°)
    if [[ " ${remotes[*]} " =~ " origin " ]] && [[ " ${remotes[*]} " =~ " upstream " ]]; then
        echo -e "${BLUE}ğŸ´ í¬í¬ëœ ì €ì¥ì†Œë¥¼ ê°ì§€í–ˆìŠµë‹ˆë‹¤.${NC}"
        echo "  - origin: $(git remote get-url origin)"
        echo "  - upstream: $(git remote get-url upstream)"
        
        # ê¸°ë³¸ì ìœ¼ë¡œ upstreamì„ ì‚¬ìš©í•˜ë˜ ì‚¬ìš©ìì—ê²Œ ì„ íƒê¶Œ ì œê³µ
        echo -e "${YELLOW}ğŸ’¡ PRì„ ì–´ëŠ ì €ì¥ì†Œë¡œ ë³´ë‚´ì‹œê² ìŠµë‹ˆê¹Œ?${NC}"
        echo "  1. upstream (ì›ë³¸ ì €ì¥ì†Œ) - ê¶Œì¥"
        echo "  2. origin (í¬í¬ëœ ì €ì¥ì†Œ)"
        
        while true; do
            read -p "ì„ íƒ (1-2, ì—”í„°í‚¤=upstream): " -r remote_choice
            
            if [ -z "$remote_choice" ] || [ "$remote_choice" = "1" ]; then
                DEFAULT_REMOTE="upstream"
                break
            elif [ "$remote_choice" = "2" ]; then
                DEFAULT_REMOTE="origin"
                break
            else
                echo -e "${RED}âŒ ì˜ëª»ëœ ì„ íƒì…ë‹ˆë‹¤. 1 ë˜ëŠ” 2ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.${NC}"
            fi
        done
    fi
    
    echo -e "${GREEN}âœ… ì‚¬ìš©í•  ì›ê²© ì €ì¥ì†Œ: $DEFAULT_REMOTE${NC}"
    echo ""
    
    # ì›ê²© ì €ì¥ì†Œ ì—°ê²° í…ŒìŠ¤íŠ¸
    if ! git ls-remote --heads "$DEFAULT_REMOTE" &>/dev/null; then
        echo -e "${RED}âŒ '$DEFAULT_REMOTE' ì›ê²© ì €ì¥ì†Œì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.${NC}"
        echo "ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì´ë‚˜ ì €ì¥ì†Œ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”."
        exit 1
    fi
}

# í•¨ìˆ˜: OpenAI API í˜¸ì¶œ
call_openai() {
    local prompt="$1"

    # ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì •ì˜
    local system_msg="ë‹¹ì‹ ì€ GitHub PR ì œëª©ê³¼ ì„¤ëª…ì„ ìƒì„±í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì»¤ë°‹ ë©”ì‹œì§€ë“¤ê³¼ ì½”ë“œ ë³€ê²½ì‚¬í•­ì„ ë¶„ì„í•˜ì—¬ ìƒì„¸í•˜ê³  êµ¬ì²´ì ì¸ PR ì„¤ëª…ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.

ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:

TITLE: [ì»¤ë°‹ë“¤ì„ ì¢…í•©í•œ 50ì ì´ë‚´ì˜ ëª…í™•í•œ ì œëª©]
DESCRIPTION:
## #ï¸âƒ£ì—°ê´€ëœ ì´ìŠˆ

resolves: #ì´ìŠˆë²ˆí˜¸

## ğŸ“ì‘ì—… ë‚´ìš©

- ê° ì»¤ë°‹ì—ì„œ ìˆ˜í–‰í•œ êµ¬ì²´ì ì¸ ì‘ì—…ë“¤ì„ ìƒì„¸íˆ ë‚˜ì—´
- ì¶”ê°€ëœ ê¸°ëŠ¥ì˜ ëª©ì ê³¼ ì‘ë™ ë°©ì‹ ì„¤ëª…
- ìˆ˜ì •ëœ ë¶€ë¶„ê³¼ ê°œì„ ì‚¬í•­ ì„¤ëª…
- ë³€ê²½ëœ íŒŒì¼ë“¤ì˜ ì—­í• ê³¼ ì˜í–¥ë„ ë¶„ì„
- ì½”ë“œ í’ˆì§ˆ ê°œì„ ì‚¬í•­ì´ë‚˜ ë¦¬íŒ©í† ë§ ë‚´ìš©

í•œêµ­ì–´ë¡œ ì‘ì„±í•˜ë˜, ê°œë°œìê°€ ì´í•´í•˜ê¸° ì‰½ê²Œ ê¸°ìˆ ì ì¸ ë‚´ìš©ë„ í¬í•¨í•´ì£¼ì„¸ìš”."

    # JSON ìš”ì²­ ìƒì„±
    local json_data=$(jq -n \
        --arg model "gpt-4o-mini" \
        --arg system "$system_msg" \
        --arg user "$prompt" \
        --argjson max_tokens 800 \
        --argjson temperature 0.3 \
        '{
            model: $model,
            messages: [
                {role: "system", content: $system},
                {role: "user", content: $user}
            ],
            max_tokens: $max_tokens,
            temperature: $temperature
        }')

    # API í˜¸ì¶œ (íƒ€ì„ì•„ì›ƒ 30ì´ˆ)
    local response
    response=$(curl -s --max-time 30 --connect-timeout 10 https://api.openai.com/v1/chat/completions \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer $OPENAI_API_KEY" \
        -d "$json_data" 2>&1)
    
    local curl_exit_code=$?
    
    if [ $curl_exit_code -ne 0 ]; then
        echo -e "${RED}âŒ API í˜¸ì¶œ ì‹¤íŒ¨ (curl ì¢…ë£Œ ì½”ë“œ: $curl_exit_code)${NC}" >&2
        echo -e "${RED}ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.${NC}" >&2
        exit 1
    fi
    
    # JSON íŒŒì‹± ë° ì˜¤ë¥˜ í™•ì¸
    local content
    content=$(echo "$response" | jq -r '.choices[0].message.content // empty' 2>/dev/null)
    
    if [ -z "$content" ]; then
        local error_msg
        error_msg=$(echo "$response" | jq -r '.error.message // "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"' 2>/dev/null)
        echo -e "${RED}âŒ API ì˜¤ë¥˜: $error_msg${NC}" >&2
        echo -e "${YELLOW}ì‘ë‹µ ë‚´ìš©: $response${NC}" >&2
        exit 1
    fi
    
    echo "$content"
}

# í•¨ìˆ˜: Anthropic API í˜¸ì¶œ
call_anthropic() {
    local prompt="$1"
    curl -s --max-time 30 https://api.anthropic.com/v1/messages \
        -H "Content-Type: application/json" \
        -H "x-api-key: $ANTHROPIC_API_KEY" \
        -H "anthropic-version: 2023-06-01" \
        -d "{
            \"model\": \"claude-3-haiku-20240307\",
            \"max_tokens\": 800,
            \"system\": \"ë‹¹ì‹ ì€ GitHub PR ì œëª©ê³¼ ì„¤ëª…ì„ ìƒì„±í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:\\n\\nTITLE: [50ì ì´ë‚´ì˜ ê°„ë‹¨í•œ ì œëª©]\\nDESCRIPTION:\\n## #ï¸âƒ£ì—°ê´€ëœ ì´ìŠˆ\\n\\nresolves: #ì´ìŠˆë²ˆí˜¸\\n\\n## ğŸ“ì‘ì—… ë‚´ìš©\\n\\n[ì´ë²ˆ PRì—ì„œ ì‘ì—…í•œ ë‚´ìš©ì„ ê°„ëµíˆ ì„¤ëª…]\\n\\ní•œêµ­ì–´ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.\",
            \"messages\": [
                {
                    \"role\": \"user\",
                    \"content\": \"$prompt\"
                }
            ]
        }" | jq -r '.content[0].text // .error.message // "API í˜¸ì¶œ ì‹¤íŒ¨"'
}

# ëª…ë ¹ì¤„ ì¸ìˆ˜ ì²˜ë¦¬
target_branch_arg=""
if [ "$1" = "--target" ] || [ "$1" = "-t" ]; then
    if [ -n "$2" ]; then
        target_branch_arg="$2"
        echo -e "${BLUE}ğŸ“Œ ëª…ë ¹ì¤„ì—ì„œ ì§€ì •ëœ ëŒ€ìƒ ë¸Œëœì¹˜: $target_branch_arg${NC}"
        echo ""
        
        # ì§€ì •ëœ ë¸Œëœì¹˜ê°€ ë¡œì»¬ê³¼ ì›ê²©ì— ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
        if ! git show-ref --verify --quiet "refs/heads/$target_branch_arg"; then
            echo -e "${RED}âŒ '$target_branch_arg' ë¡œì»¬ ë¸Œëœì¹˜ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.${NC}"
            exit 1
        fi
        
        if ! git ls-remote --heads "$DEFAULT_REMOTE" "$target_branch_arg" | grep -q "$target_branch_arg"; then
            echo -e "${YELLOW}âš ï¸  '$target_branch_arg' ë¸Œëœì¹˜ê°€ ì›ê²© ì €ì¥ì†Œì— ì—†ìŠµë‹ˆë‹¤.${NC}"
            echo -e "${BLUE}ğŸ’¡ PR ìƒì„±ì„ ìœ„í•´ ë¨¼ì € ì›ê²©ì— í‘¸ì‹œê°€ í•„ìš”í•©ë‹ˆë‹¤.${NC}"
            read -p "ì§€ê¸ˆ í‘¸ì‹œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/N): " -r
            if [[ $REPLY =~ ^[Yy]$ ]]; then
                echo -e "${BLUE}ğŸ“¤ '$target_branch_arg' ë¸Œëœì¹˜ë¥¼ ì›ê²©ìœ¼ë¡œ í‘¸ì‹œ ì¤‘...${NC}"
                if git push -u "$DEFAULT_REMOTE" "$target_branch_arg"; then
                    echo -e "${GREEN}âœ… í‘¸ì‹œ ì™„ë£Œ${NC}"
                else
                    echo -e "${RED}âŒ í‘¸ì‹œ ì‹¤íŒ¨${NC}"
                    exit 1
                fi
            else
                echo -e "${YELLOW}âŒ ì›ê²© í‘¸ì‹œ ì—†ì´ëŠ” PRì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.${NC}"
                echo -e "${BLUE}ğŸ’¡ ìˆ˜ë™ìœ¼ë¡œ í‘¸ì‹œí•˜ë ¤ë©´: git push -u $DEFAULT_REMOTE $target_branch_arg${NC}"
                exit 1
            fi
        fi
    else
        echo -e "${RED}âŒ --target ì˜µì…˜ì—ëŠ” ë¸Œëœì¹˜ëª…ì´ í•„ìš”í•©ë‹ˆë‹¤.${NC}"
        echo "ì‚¬ìš©ë²•: aipr --target <ë¸Œëœì¹˜ëª…>"
        exit 1
    fi
elif [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    echo "AI PR ìƒì„± ë„êµ¬"
    echo ""
    echo "ì‚¬ìš©ë²•:"
    echo "  aipr                    # ëŒ€í™”í˜• ë¸Œëœì¹˜ ì„ íƒ"
    echo "  aipr --target <ë¸Œëœì¹˜>   # ëŒ€ìƒ ë¸Œëœì¹˜ ì§ì ‘ ì§€ì •"
    echo "  aipr -t <ë¸Œëœì¹˜>        # ëŒ€ìƒ ë¸Œëœì¹˜ ì§ì ‘ ì§€ì • (ë‹¨ì¶•í˜•)"
    echo ""
    echo "ì˜ˆì‹œ:"
    echo "  aipr --target main"
    echo "  aipr -t develop"
    exit 0
fi

# API í‚¤ ë° GitHub CLI í™•ì¸ (ë„ì›€ë§ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ)
if [ "$1" != "--help" ] && [ "$1" != "-h" ]; then
    check_api_key
    check_gh_cli
    setup_remote_repository
fi

# í˜„ì¬ ë¸Œëœì¹˜ í™•ì¸ (ë„ì›€ë§ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ)
if [ "$1" != "--help" ] && [ "$1" != "-h" ]; then
    current_branch=$(git branch --show-current)
    if [ "$current_branch" = "main" ] || [ "$current_branch" = "master" ]; then
        echo -e "${RED}âŒ main/master ë¸Œëœì¹˜ì—ì„œëŠ” PRì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.${NC}"
        echo "ìƒˆ ë¸Œëœì¹˜ë¥¼ ìƒì„±í•˜ê±°ë‚˜ ê¸°ì¡´ ë¸Œëœì¹˜ë¡œ ì „í™˜í•´ì£¼ì„¸ìš”."
        exit 1
    fi
fi

# í˜„ì¬ ë¸Œëœì¹˜ë¥¼ ì ì ˆí•œ ì›ê²© ì €ì¥ì†Œë¡œ í‘¸ì‹œ
push_current_branch() {
    # í¬í¬ëœ ì €ì¥ì†Œì¸ ê²½ìš° í˜„ì¬ ë¸Œëœì¹˜ëŠ” originì— í‘¸ì‹œ
    local push_remote="origin"
    
    # originì´ ì—†ìœ¼ë©´ DEFAULT_REMOTE ì‚¬ìš©
    if ! git remote | grep -q "^origin$"; then
        push_remote="$DEFAULT_REMOTE"
    fi
    
    echo -e "${BLUE}ğŸ“¤ í˜„ì¬ ë¸Œëœì¹˜ë¥¼ $push_remoteë¡œ í‘¸ì‹œí•©ë‹ˆë‹¤...${NC}"
    
    # í‘¸ì‹œë˜ì§€ ì•Šì€ ì»¤ë°‹ì´ ìˆëŠ”ì§€ í™•ì¸
    if ! git diff --quiet HEAD "$push_remote"/"$current_branch" 2>/dev/null; then
        echo -e "${BLUE}ğŸ“¤ ë³€ê²½ì‚¬í•­ì„ ì›ê²© ì €ì¥ì†Œë¡œ í‘¸ì‹œí•©ë‹ˆë‹¤...${NC}"
        git push "$push_remote" "$current_branch" || {
            echo -e "${BLUE}ğŸ“¤ ì²« ë²ˆì§¸ í‘¸ì‹œì…ë‹ˆë‹¤...${NC}"
            git push -u "$push_remote" "$current_branch"
        }
    fi
}

push_current_branch

# ëŒ€ìƒ ë¸Œëœì¹˜ ì„ íƒ
if [ -n "$target_branch_arg" ]; then
    # ëª…ë ¹ì¤„ì—ì„œ ì§€ì •ëœ ê²½ìš°
    target_branch="$target_branch_arg"
else
    # ëŒ€í™”í˜• ì„ íƒ
    echo -e "${BLUE}ğŸ¯ PRì„ ë³´ë‚¼ ëŒ€ìƒ ë¸Œëœì¹˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”:${NC}"
    echo ""

    # ì‚¬ìš© ê°€ëŠ¥í•œ ë¸Œëœì¹˜ ëª©ë¡ í‘œì‹œ (ë¡œì»¬ì— ìˆëŠ” ëª¨ë“  ë¸Œëœì¹˜ë“¤)
    available_branches=()
    remote_status=()
    
    # í˜„ì¬ ë¸Œëœì¹˜ë¥¼ ì œì™¸í•œ ëª¨ë“  ë¡œì»¬ ë¸Œëœì¹˜ ê°€ì ¸ì˜¤ê¸°
    local all_branches=($(git branch --format='%(refname:short)' | grep -v "^$current_branch$"))
    
    # ì£¼ìš” ë¸Œëœì¹˜ë“¤ì„ ìš°ì„ ì ìœ¼ë¡œ ë°°ì¹˜
    local priority_branches=("main" "master" "dev" "develop")
    
    # ìš°ì„ ìˆœìœ„ ë¸Œëœì¹˜ë“¤ì„ ë¨¼ì € ì¶”ê°€
    for priority_branch in "${priority_branches[@]}"; do
        if [[ " ${all_branches[*]} " =~ " $priority_branch " ]]; then
            available_branches+=("$priority_branch")
            # ì›ê²©ì— ìˆëŠ”ì§€ í™•ì¸
            if git ls-remote --heads "$DEFAULT_REMOTE" "$priority_branch" | grep -q "$priority_branch"; then
                remote_status+=("âœ…")
            else
                remote_status+=("ğŸ“¤")
            fi
        fi
    done
    
    # ë‚˜ë¨¸ì§€ ë¸Œëœì¹˜ë“¤ì„ ì•ŒíŒŒë²³ ìˆœìœ¼ë¡œ ì¶”ê°€
    for branch in $(printf '%s\n' "${all_branches[@]}" | grep -v -E '^(main|master|dev|develop)$' | sort); do
        available_branches+=("$branch")
        # ì›ê²©ì— ìˆëŠ”ì§€ í™•ì¸
        if git ls-remote --heads "$DEFAULT_REMOTE" "$branch" | grep -q "$branch"; then
            remote_status+=("âœ…")
        else
            remote_status+=("ğŸ“¤")
        fi
    done
    
    # ë¸Œëœì¹˜ê°€ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ ê¸°ë³¸ ë¸Œëœì¹˜ë¼ë„ í‘œì‹œ
    if [ ${#available_branches[@]} -eq 0 ]; then
        if git show-ref --verify --quiet refs/heads/main; then
            available_branches+=("main")
            remote_status+=("âœ…")
        elif git show-ref --verify --quiet refs/heads/master; then
            available_branches+=("master")
            remote_status+=("âœ…")
        fi
    fi

    # ê¸°ë³¸ ë¸Œëœì¹˜ ì„¤ì • (ì‚¬ìš© ê°€ëŠ¥í•œ ë¸Œëœì¹˜ ì¤‘ì—ì„œ ì„ íƒ)
    default_branch=""
    if [ ${#available_branches[@]} -gt 0 ]; then
        # ìš°ì„ ìˆœìœ„: main > master > dev > develop > ì²« ë²ˆì§¸ ë¸Œëœì¹˜
        for priority in "main" "master" "dev" "develop"; do
            if [[ " ${available_branches[*]} " =~ " $priority " ]]; then
                default_branch="$priority"
                break
            fi
        done
        
        # ìš°ì„ ìˆœìœ„ ë¸Œëœì¹˜ê°€ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ë¸Œëœì¹˜ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ
        if [ -z "$default_branch" ]; then
            default_branch="${available_branches[0]}"
        fi
    else
        # ì‚¬ìš© ê°€ëŠ¥í•œ ë¸Œëœì¹˜ê°€ ì—†ìœ¼ë©´ main/master ì¤‘ í•˜ë‚˜
        if git show-ref --verify --quiet refs/heads/main; then
            default_branch="main"
        else
            default_branch="master"
        fi
    fi

    # ë¸Œëœì¹˜ ì„ íƒ ë©”ë‰´ í‘œì‹œ
    echo "ì‚¬ìš© ê°€ëŠ¥í•œ ë¸Œëœì¹˜ (ì´ ${#available_branches[@]}ê°œ):"
    
    # ë¸Œëœì¹˜ê°€ ë§ì„ ë•ŒëŠ” ì²˜ìŒ 20ê°œë§Œ í‘œì‹œí•˜ê³  ë”ë³´ê¸° ì˜µì…˜ ì œê³µ
    local display_limit=20
    local show_all=false
    
    if [ ${#available_branches[@]} -gt $display_limit ] && [ "$show_all" = false ]; then
        echo -e "${YELLOW}ğŸ’¡ ë¸Œëœì¹˜ê°€ ë§ìŠµë‹ˆë‹¤. ì²˜ìŒ ${display_limit}ê°œë§Œ í‘œì‹œí•©ë‹ˆë‹¤.${NC}"
        echo ""
        
        for i in $(seq 0 $((display_limit-1))); do
            if [ $i -lt ${#available_branches[@]} ]; then
                branch="${available_branches[$i]}"
                status="${remote_status[$i]}"
                
                if [ "$branch" = "$default_branch" ]; then
                    echo -e "${GREEN}  $((i+1)). $branch (ê¸°ë³¸) $status${NC}"
                else
                    echo -e "${BLUE}  $((i+1)). $branch $status${NC}"
                fi
            fi
        done
        
        echo ""
        echo -e "${YELLOW}  a. ëª¨ë“  ë¸Œëœì¹˜ ë³´ê¸° (${#available_branches[@]}ê°œ)${NC}"
    else
        for i in "${!available_branches[@]}"; do
            branch="${available_branches[$i]}"
            status="${remote_status[$i]}"
            
            if [ "$branch" = "$default_branch" ]; then
                echo -e "${GREEN}  $((i+1)). $branch (ê¸°ë³¸) $status${NC}"
            else
                echo -e "${BLUE}  $((i+1)). $branch $status${NC}"
            fi
        done
    fi
    
    echo ""
    echo -e "${YELLOW}ë²”ë¡€: âœ… ì›ê²©ì— ìˆìŒ, ğŸ“¤ ì›ê²© í‘¸ì‹œ í•„ìš”${NC}"

    # ì§ì ‘ ë¸Œëœì¹˜ëª… ì…ë ¥ ì˜µì…˜
    echo -e "${YELLOW}  0. ì§ì ‘ ì…ë ¥${NC}"
    echo ""

    # ì‚¬ìš©ì ì…ë ¥ ë°›ê¸°
    while true; do
        if [ ${#available_branches[@]} -gt $display_limit ] && [ "$show_all" = false ]; then
            read -p "ì„ íƒ (1-$display_limit, a=ëª¨ë‘ë³´ê¸°, 0=ì§ì ‘ì…ë ¥, ì—”í„°í‚¤=ê¸°ë³¸ê°’): " -r choice
        else
            read -p "ì„ íƒ (1-${#available_branches[@]} ë˜ëŠ” 0, ì—”í„°í‚¤=ê¸°ë³¸ê°’): " -r choice
        fi
        
        if [ -z "$choice" ]; then
            # ì—”í„°í‚¤ë§Œ ëˆŒë €ì„ ë•Œ ê¸°ë³¸ê°’ ì‚¬ìš©
            target_branch="$default_branch"
            break
        elif [ "$choice" = "a" ] && [ ${#available_branches[@]} -gt $display_limit ] && [ "$show_all" = false ]; then
            # ëª¨ë“  ë¸Œëœì¹˜ ë³´ê¸°
            show_all=true
            echo ""
            echo "ëª¨ë“  ë¸Œëœì¹˜ (ì´ ${#available_branches[@]}ê°œ):"
            for i in "${!available_branches[@]}"; do
                branch="${available_branches[$i]}"
                status="${remote_status[$i]}"
                
                if [ "$branch" = "$default_branch" ]; then
                    echo -e "${GREEN}  $((i+1)). $branch (ê¸°ë³¸) $status${NC}"
                else
                    echo -e "${BLUE}  $((i+1)). $branch $status${NC}"
                fi
            done
            echo ""
            echo -e "${YELLOW}ë²”ë¡€: âœ… ì›ê²©ì— ìˆìŒ, ğŸ“¤ ì›ê²© í‘¸ì‹œ í•„ìš”${NC}"
            echo -e "${YELLOW}  0. ì§ì ‘ ì…ë ¥${NC}"
            echo ""
            continue
        elif [[ "$choice" =~ ^[1-9][0-9]*$ ]] && [ "$choice" -le "${#available_branches[@]}" ]; then
            # ìˆ«ì ì„ íƒ
            target_branch="${available_branches[$((choice-1))]}"
            break
        elif [ "$choice" = "0" ]; then
            # ì§ì ‘ ì…ë ¥
            while true; do
                read -p "ëŒ€ìƒ ë¸Œëœì¹˜ëª…ì„ ì…ë ¥í•˜ì„¸ìš”: " -r target_branch
                if [ -n "$target_branch" ]; then
                    if ! git show-ref --verify --quiet "refs/heads/$target_branch"; then
                        echo -e "${RED}âŒ '$target_branch' ë¡œì»¬ ë¸Œëœì¹˜ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”.${NC}"
                        continue
                    fi
                    
                    if ! git ls-remote --heads "$DEFAULT_REMOTE" "$target_branch" | grep -q "$target_branch"; then
                        echo -e "${YELLOW}âš ï¸  '$target_branch' ë¸Œëœì¹˜ê°€ ì›ê²© ì €ì¥ì†Œì— ì—†ìŠµë‹ˆë‹¤.${NC}"
                        echo -e "${BLUE}ğŸ’¡ PR ìƒì„±ì„ ìœ„í•´ ë¨¼ì € ì›ê²©ì— í‘¸ì‹œê°€ í•„ìš”í•©ë‹ˆë‹¤.${NC}"
                        read -p "ì§€ê¸ˆ í‘¸ì‹œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/N): " -r
                        if [[ $REPLY =~ ^[Yy]$ ]]; then
                            echo -e "${BLUE}ğŸ“¤ '$target_branch' ë¸Œëœì¹˜ë¥¼ ì›ê²©ìœ¼ë¡œ í‘¸ì‹œ ì¤‘...${NC}"
                            if git push -u "$DEFAULT_REMOTE" "$target_branch"; then
                                echo -e "${GREEN}âœ… í‘¸ì‹œ ì™„ë£Œ${NC}"
                                break
                            else
                                echo -e "${RED}âŒ í‘¸ì‹œ ì‹¤íŒ¨${NC}"
                                continue
                            fi
                        else
                            echo -e "${YELLOW}ë‹¤ë¥¸ ë¸Œëœì¹˜ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ìˆ˜ë™ìœ¼ë¡œ í‘¸ì‹œí•˜ì„¸ìš”.${NC}"
                            continue
                        fi
                    fi
                    
                    break
                fi
            done
            break
        else
            echo -e "${RED}âŒ ì˜ëª»ëœ ì„ íƒì…ë‹ˆë‹¤. ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”.${NC}"
        fi
    done

    echo -e "${GREEN}âœ… ëŒ€ìƒ ë¸Œëœì¹˜: $target_branch${NC}"
    echo ""
fi

echo -e "${BLUE}ğŸ¤– AIê°€ PR ì œëª©ê³¼ ì„¤ëª…ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...${NC}"
echo ""

# ë¸Œëœì¹˜ëª…ì—ì„œ íƒ€ì…ê³¼ ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ (ì˜ˆ: feat/#123 -> feat, 123)
branch_type=""
issue_number=""

# ë¸Œëœì¹˜ íƒ€ì… ì¶”ì¶œ (feat, fix, chore, docs ë“±)
if [[ "$current_branch" =~ ^([^/]+)/ ]]; then
    branch_type="${BASH_REMATCH[1]}"
fi

# ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ
if [[ "$current_branch" =~ /#([0-9]+) ]]; then
    issue_number="${BASH_REMATCH[1]}"
elif [[ "$current_branch" =~ /([0-9]+)$ ]]; then
    issue_number="${BASH_REMATCH[1]}"
fi

# ë³€ê²½ì‚¬í•­ ì •ë³´ ìˆ˜ì§‘ (ëŒ€ìƒ ë¸Œëœì¹˜ì— ì—†ëŠ” ìƒˆë¡œìš´ ì»¤ë°‹ë“¤ë§Œ)
changed_files=$(git diff --name-only "$target_branch"..."$current_branch")
git_diff=$(git diff "$target_branch"..."$current_branch")
commit_messages=$(git log "$target_branch".."$current_branch" --oneline)
commit_details=$(git log "$target_branch".."$current_branch" --pretty=format:"- %s%n  %b" | grep -v "^$")

# ì»¤ë°‹ì´ ì—†ìœ¼ë©´ ì¢…ë£Œ
if [ -z "$commit_messages" ]; then
    echo -e "${RED}âŒ $target_branch ë¸Œëœì¹˜ì™€ ë¹„êµí–ˆì„ ë•Œ ìƒˆë¡œìš´ ì»¤ë°‹ì´ ì—†ìŠµë‹ˆë‹¤.${NC}"
    echo "ë³€ê²½ì‚¬í•­ì„ ì»¤ë°‹í•˜ê±°ë‚˜ ì˜¬ë°”ë¥¸ ë¸Œëœì¹˜ì—ì„œ ì‹¤í–‰í•´ì£¼ì„¸ìš”."
    exit 1
fi

# í”„ë¡¬í”„íŠ¸ ìƒì„±
prompt="ë‹¤ìŒ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ GitHub Pull Requestì˜ ì œëª©ê³¼ ì„¤ëª…ì„ ìƒì„±í•´ì£¼ì„¸ìš”:

ë¸Œëœì¹˜: $current_branch â†’ $target_branch
ë¸Œëœì¹˜ íƒ€ì…: ${branch_type:-"ì—†ìŒ"}
ì´ìŠˆ ë²ˆí˜¸: ${issue_number:-"ì—†ìŒ"}

ë³€ê²½ëœ íŒŒì¼ ëª©ë¡:
$changed_files

ìƒˆë¡œìš´ ì»¤ë°‹ë“¤ ($target_branch ë¸Œëœì¹˜ì— ì—†ëŠ” ê²ƒë“¤):
$commit_messages

ìƒì„¸ ì»¤ë°‹ ë‚´ìš©:
$commit_details

ì½”ë“œ ë³€ê²½ì‚¬í•­ (ì¼ë¶€):
$(echo "$git_diff" | head -200)

ìš”êµ¬ì‚¬í•­:
1. ì œëª©ì€ 50ì ì´ë‚´ë¡œ ê°„ê²°í•˜ê²Œ (ì»¤ë°‹ ë©”ì‹œì§€ë“¤ì„ ì¢…í•©í•´ì„œ)
   - ë¸Œëœì¹˜ íƒ€ì…ì´ ìˆìœ¼ë©´ ì œëª© ì•ì— íƒ€ì…ì„ ì¶”ê°€
   - ì˜ˆ: feat: íŒŒì¼ ì—…ë¡œë“œ ê¸°ëŠ¥ ì¶”ê°€, fix: ë¡œê·¸ì¸ ì˜¤ë¥˜ ìˆ˜ì •
2. ì„¤ëª… í˜•ì‹:
   ## #ï¸âƒ£ì—°ê´€ëœ ì´ìŠˆ
   resolves: #ì´ìŠˆë²ˆí˜¸

   ## ğŸ“ì‘ì—… ë‚´ìš©
   - ê° ì»¤ë°‹ì—ì„œ ì‘ì—…í•œ êµ¬ì²´ì ì¸ ë‚´ìš©ë“¤ì„ ì •ë¦¬
   - ì¶”ê°€ëœ ê¸°ëŠ¥, ìˆ˜ì •ëœ ë¶€ë¶„, ê°œì„ ì‚¬í•­ ë“±ì„ ìƒì„¸íˆ ì„¤ëª…
   - ë³€ê²½ëœ íŒŒì¼ë“¤ì˜ ì—­í• ê³¼ ëª©ì  ì„¤ëª…
   - ì½”ë“œ ë³€ê²½ì‚¬í•­ì´ í”„ë¡œì íŠ¸ì— ë¯¸ì¹˜ëŠ” ì˜í–¥
3. NestJS í”„ë¡œì íŠ¸ì„ì„ ê³ ë ¤ (ì»¨íŠ¸ë¡¤ëŸ¬, ì„œë¹„ìŠ¤, ëª¨ë“ˆ ë“±)
4. í•œêµ­ì–´ë¡œ ì‘ì„±
5. ì»¤ë°‹ ë©”ì‹œì§€ë“¤ì„ ì¢…í•©í•˜ì—¬ ì „ì²´ì ì¸ ë§¥ë½ì„ íŒŒì•…í•´ì„œ ì‘ì„±

ì‘ë‹µ í˜•ì‹:
TITLE: [ì œëª©]
DESCRIPTION:
[ì„¤ëª… ë‚´ìš©]"

# AI API í˜¸ì¶œ
if [ -n "$OPENAI_API_KEY" ]; then
    echo -e "${BLUE}ğŸ“¡ OpenAI API í˜¸ì¶œ ì¤‘... (30ì´ˆ íƒ€ì„ì•„ì›ƒ)${NC}"
    ai_response=$(call_openai "$prompt")
elif [ -n "$ANTHROPIC_API_KEY" ]; then
    echo -e "${BLUE}ğŸ“¡ Anthropic API í˜¸ì¶œ ì¤‘... (30ì´ˆ íƒ€ì„ì•„ì›ƒ)${NC}"
    ai_response=$(call_anthropic "$prompt")
else
    echo -e "${RED}âŒ API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.${NC}"
    exit 1
fi

echo -e "${GREEN}âœ… AI ì‘ë‹µ ë°›ìŒ (${#ai_response}ì)${NC}"

# ì œëª©ê³¼ ì„¤ëª… ë¶„ë¦¬
pr_title=$(echo "$ai_response" | grep "^TITLE:" | sed 's/^TITLE: //')
pr_description=$(echo "$ai_response" | sed '/^TITLE:/d' | sed '/^DESCRIPTION:/d' | sed '/^$/d')

if [ -z "$pr_title" ]; then
    pr_title="$current_branch ë¸Œëœì¹˜ ë³€ê²½ì‚¬í•­"
fi

# ë¸Œëœì¹˜ íƒ€ì…ì´ ìˆê³  ì œëª©ì— ì•„ì§ í¬í•¨ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì¶”ê°€
if [ -n "$branch_type" ] && [[ ! "$pr_title" =~ ^[a-z]+: ]]; then
    pr_title="${branch_type}: ${pr_title}"
fi

# ì´ìŠˆ ë²ˆí˜¸ê°€ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ì¹˜í™˜
if [ -n "$issue_number" ]; then
    pr_description=$(echo "$pr_description" | sed "s/#ì´ìŠˆë²ˆí˜¸/#$issue_number/g")
fi

echo -e "${GREEN}âœ¨ AIê°€ ìƒì„±í•œ PR ì •ë³´:${NC}"
echo "================================"
echo -e "${YELLOW}ì œëª©:${NC} $pr_title"
echo ""
echo -e "${YELLOW}ì„¤ëª…:${NC}"
echo "$pr_description"
echo "================================"
echo ""

# ì‚¬ìš©ì í™•ì¸
read -p "ì´ ë‚´ìš©ìœ¼ë¡œ PRì„ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/N): " -r

if [[ $REPLY =~ ^[Yy]$ ]]; then
    # PR ìƒì„±
    echo -e "${BLUE}ğŸ“ PRì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...${NC}"

    # ì„ì‹œ íŒŒì¼ì— ì„¤ëª… ì €ì¥
    temp_file=$(mktemp)
    echo "$pr_description" > "$temp_file"

    # GitHub CLIë¡œ PR ìƒì„±
    # í¬í¬ëœ ì €ì¥ì†Œì—ì„œ upstreamìœ¼ë¡œ PRì„ ë³´ë‚´ëŠ” ê²½ìš° ì²˜ë¦¬
    if [ "$DEFAULT_REMOTE" = "upstream" ]; then
        # í˜„ì¬ ë¸Œëœì¹˜ê°€ originì— ìˆê³  upstreamìœ¼ë¡œ PRì„ ë³´ë‚´ëŠ” ê²½ìš°
        origin_user=$(git remote get-url origin | sed -n 's/.*github.com[:/]\([^/]*\)\/.*/\1/p')
        pr_url=$(gh pr create --title "$pr_title" --body-file "$temp_file" --base "$target_branch" --head "$origin_user:$current_branch" --repo $(git remote get-url upstream | sed -n 's/.*github.com[:/]\([^/]*\/[^/]*\)\.git.*/\1/p'))
    else
        # ì¼ë°˜ì ì¸ ê²½ìš° (originì—ì„œ originìœ¼ë¡œ, ë˜ëŠ” ë‹¨ì¼ ì›ê²© ì €ì¥ì†Œ)
        pr_url=$(gh pr create --title "$pr_title" --body-file "$temp_file" --base "$target_branch" --head "$current_branch")
    fi

    # ì„ì‹œ íŒŒì¼ ì‚­ì œ
    rm "$temp_file"

    echo -e "${GREEN}âœ… PRì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!${NC}"
    echo -e "${BLUE}ğŸ”— PR URL: $pr_url${NC}"

    # ë¸Œë¼ìš°ì €ì—ì„œ ì—´ê¸° (ì„ íƒì‚¬í•­)
    read -p "ë¸Œë¼ìš°ì €ì—ì„œ PRì„ ì—¬ì‹œê² ìŠµë‹ˆê¹Œ? (y/N): " -r
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        gh pr view --web
    fi

else
    echo -e "${YELLOW}âŒ PR ìƒì„±ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.${NC}"
    echo -e "${BLUE}ğŸ’¡ ìˆ˜ë™ìœ¼ë¡œ PRì„ ìƒì„±í•˜ë ¤ë©´:${NC}"
    echo "gh pr create --title \"$pr_title\" --body \"$pr_description\""
fi
