#!/bin/bash

# AI ê¸°ë°˜ ìë™ ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„± ìŠ¤í¬ë¦½íŠ¸
# ì‚¬ìš©ë²•: ./scripts/ai-commit.sh

set -e

# ìƒ‰ìƒ ì •ì˜
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# í•¨ìˆ˜: API í‚¤ í™•ì¸
check_api_key() {
    if [ -z "$OPENAI_API_KEY" ] && [ -z "$ANTHROPIC_API_KEY" ]; then
        echo -e "${RED}âŒ API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.${NC}"
        echo ""
        echo "ë‹¤ìŒ ì¤‘ í•˜ë‚˜ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”:"
        echo "1. OpenAI API: export OPENAI_API_KEY='your-key'"
        echo "2. Anthropic API: export ANTHROPIC_API_KEY='your-key'"
        echo ""
        echo "ë˜ëŠ” .env íŒŒì¼ì— ì¶”ê°€:"
        echo "OPENAI_API_KEY=your-key"
        echo "ANTHROPIC_API_KEY=your-key"
        exit 1
    fi
}

# í•¨ìˆ˜: OpenAI API í˜¸ì¶œ
call_openai() {
    local prompt="$1"

    # ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì •ì˜
    local system_msg="ë‹¹ì‹ ì€ git ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ ìƒì„±í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤. Conventional Commits í˜•ì‹ì„ ë”°ë¥´ë©°, í•œêµ­ì–´ë¡œ ëª…í™•í•˜ê³  ê°„ê²°í•œ ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤. í˜•ì‹: 'type: ê°„ë‹¨í•œ ì„¤ëª…\n\nìƒì„¸ ë‚´ìš©(í•„ìš”ì‹œ)' NestJS í”„ë¡œì íŠ¸ì˜ ë§¥ë½ì„ ì´í•´í•˜ê³  ì ì ˆí•œ ë©”ì‹œì§€ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”."

    # JSON ìš”ì²­ ìƒì„±
    local json_data=$(jq -n \
        --arg model "gpt-4o-mini" \
        --arg system "$system_msg" \
        --arg user "$prompt" \
        --argjson max_tokens 500 \
        --argjson temperature 0.3 \
        '{
            model: $model,
            messages: [
                {role: "system", content: $system},
                {role: "user", content: $user}
            ],
            max_tokens: $max_tokens,
            temperature: $temperature
        }')

    curl -s https://api.openai.com/v1/chat/completions \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer $OPENAI_API_KEY" \
        -d "$json_data" | jq -r '.choices[0].message.content'
}

# í•¨ìˆ˜: Anthropic API í˜¸ì¶œ
call_anthropic() {
    local prompt="$1"
    curl -s https://api.anthropic.com/v1/messages \
        -H "Content-Type: application/json" \
        -H "x-api-key: $ANTHROPIC_API_KEY" \
        -H "anthropic-version: 2023-06-01" \
        -d "{
            \"model\": \"claude-3-haiku-20240307\",
            \"max_tokens\": 500,
            \"system\": \"ë‹¹ì‹ ì€ git ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ ìƒì„±í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤. Conventional Commits í˜•ì‹ì„ ë”°ë¥´ë©°, í•œêµ­ì–´ë¡œ ëª…í™•í•˜ê³  ê°„ê²°í•œ ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤. í˜•ì‹: 'type: ê°„ë‹¨í•œ ì„¤ëª…\\n\\nìƒì„¸ ë‚´ìš©(í•„ìš”ì‹œ)' NestJS í”„ë¡œì íŠ¸ì˜ ë§¥ë½ì„ ì´í•´í•˜ê³  ì ì ˆí•œ ë©”ì‹œì§€ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.\",
            \"messages\": [
                {
                    \"role\": \"user\",
                    \"content\": \"$prompt\"
                }
            ]
        }" | jq -r '.content[0].text'
}

# ëª…ë ¹ì¤„ ì¸ìˆ˜ ì²˜ë¦¬
if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    echo "AI ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„± ë„êµ¬"
    echo ""
    echo "ì‚¬ìš©ë²•:"
    echo "  aicommit    # stagedëœ ë³€ê²½ì‚¬í•­ì„ ë¶„ì„í•˜ì—¬ ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±"
    echo ""
    echo "ì‚¬ì „ ìš”êµ¬ì‚¬í•­:"
    echo "  1. ë³€ê²½ì‚¬í•­ì„ stage: git add <íŒŒì¼ëª…>"
    echo "  2. API í‚¤ ì„¤ì •: ~/.ai-dev-tools/config.sh"
    echo ""
    echo "ì˜ˆì‹œ:"
    echo "  git add ."
    echo "  aicommit"
    exit 0
fi

# ì„¤ì • ë¡œë“œ
source ~/.ai-dev-tools/config.sh

# API í‚¤ í™•ì¸
check_api_key

# staged íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
if ! git diff --cached --quiet; then
    echo -e "${BLUE}ğŸ¤– AIê°€ ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...${NC}"
    echo ""

    # Git diff ì •ë³´ ìˆ˜ì§‘
    staged_files=$(git diff --cached --name-only)
    git_diff=$(git diff --cached)
    git_stat=$(git diff --cached --stat)

    # í”„ë¡¬í”„íŠ¸ ìƒì„±
    prompt="ë‹¤ìŒ git ë³€ê²½ì‚¬í•­ì„ ë¶„ì„í•˜ì—¬ ì ì ˆí•œ ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”:

ë³€ê²½ëœ íŒŒì¼ ëª©ë¡:
$staged_files

ë³€ê²½ í†µê³„:
$git_stat

ìƒì„¸ ë³€ê²½ ë‚´ìš© (ì¼ë¶€):
$(echo "$git_diff" | head -100)

ìš”êµ¬ì‚¬í•­:
1. Conventional Commits í˜•ì‹ ì‚¬ìš© (feat:, fix:, chore:, docs:, test: ë“±)
2. í•œêµ­ì–´ë¡œ ì‘ì„±
3. ì²« ì¤„ì€ 50ì ì´ë‚´ì˜ ê°„ë‹¨í•œ ìš”ì•½
4. í•„ìš”ì‹œ ë¹ˆ ì¤„ í›„ ìƒì„¸ ì„¤ëª… ì¶”ê°€
5. NestJS í”„ë¡œì íŠ¸ì„ì„ ê³ ë ¤í•˜ì—¬ ì»¨íŠ¸ë¡¤ëŸ¬, ì„œë¹„ìŠ¤, ëª¨ë“ˆ ë“±ì˜ ë§¥ë½ ë°˜ì˜

ì»¤ë°‹ ë©”ì‹œì§€ë§Œ ë°˜í™˜í•´ì£¼ì„¸ìš” (ë‹¤ë¥¸ ì„¤ëª… ì—†ì´):"

    # AI API í˜¸ì¶œ
    if [ -n "$OPENAI_API_KEY" ]; then
        echo -e "${BLUE}ğŸ“¡ OpenAI API í˜¸ì¶œ ì¤‘...${NC}"
        commit_message=$(call_openai "$prompt")
    elif [ -n "$ANTHROPIC_API_KEY" ]; then
        echo -e "${BLUE}ğŸ“¡ Anthropic API í˜¸ì¶œ ì¤‘...${NC}"
        commit_message=$(call_anthropic "$prompt")
    fi

    # API ì‘ë‹µ í™•ì¸
    if [ -z "$commit_message" ] || [ "$commit_message" = "null" ]; then
        echo -e "${RED}âŒ AI API í˜¸ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.${NC}"
        echo "ìˆ˜ë™ìœ¼ë¡œ ì»¤ë°‹í•˜ê±°ë‚˜ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
        exit 1
    fi

    echo -e "${GREEN}âœ¨ AIê°€ ìƒì„±í•œ ì»¤ë°‹ ë©”ì‹œì§€:${NC}"
    echo "================================"
    echo "$commit_message"
    echo "================================"
    echo ""

    # ì‚¬ìš©ì í™•ì¸
    read -p "ì´ ë©”ì‹œì§€ë¡œ ì»¤ë°‹í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/N): " -r
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        git commit -m "$commit_message"
        echo -e "${GREEN}âœ… ì»¤ë°‹ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!${NC}"
    else
        echo -e "${YELLOW}âŒ ì»¤ë°‹ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.${NC}"
        echo -e "${BLUE}ğŸ’¡ ìƒì„±ëœ ë©”ì‹œì§€ë¥¼ ìˆ˜ì •í•´ì„œ ì‚¬ìš©í•˜ë ¤ë©´:${NC}"
        echo "git commit -m \"$commit_message\""
    fi

else
    echo -e "${RED}âŒ stagedëœ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.${NC}"
    echo -e "${BLUE}ğŸ’¡ íŒŒì¼ì„ stageí•˜ë ¤ë©´: git add <íŒŒì¼ëª…>${NC}"
fi
